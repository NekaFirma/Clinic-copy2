name: .NET
on:
  pull_request:
    branches: [ main, develop ]
jobs:
  changedfiles:
    runs-on: ubuntu-latest
    # Map a step output to a job output
    steps:
      - name: CheckChangedFiles
        uses: Amadevus/pwsh-script@v2.0.1
        with:
          script: |
                echo "Pipeline triggered by PR: checking which files were changed."
                $files=$(git diff HEAD HEAD~ --name-only)
                $paths = $env:PATHS -split ' '

                $shouldBuild = $false
                foreach ($path in $paths) 
                { 
                    if($files -like $path) 
                    {
                        $shouldBuild = $true
                        break
                    } 
                }
                if ($shouldBuild)
                {
                    echo "Watched files were changed."
                    echo "Build will execute."
                    Write-Host "##vso[task.setvariable variable=shouldBuild;isOutput=true]Yes"
                }
                else
                {
                    echo "Watched files were not changed."
                    echo "Build will not execute."
                    Write-Host "##vso[task.setvariable variable=shouldBuild;isOutput=true]No"
                }
  build-and-test:
    runs-on: ubuntu-latest
    needs: changedfiles
    env:
      config: Release
      PROJECT: 'HealthCareClinic/Hospital/Hospital.csproj'
      TEST: 'HealthCareClinic/HospitalTests/HospitalTests.csproj'
    steps:
    - uses: actions/checkout@v2
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 3.1.x
        
    - name: Restore dependencies
      run: dotnet restore $PROJECT
      
    - name: Build
      run: dotnet build $PROJECT --configuration $config --no-restore 
      
    - name: Test with dotnet
      run: dotnet test $TEST --verbosity quiet
